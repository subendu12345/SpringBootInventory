<!DOCTYPE html>
<html lang="en" xmlns="http://www.thymeleaf.org" th:replace="base::layout(~{::section})">

</html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Sale Detail</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>

</head>

<body>
    <section>
        <div class="container-fluid mt-5">
            <div class="card shadow rounded-lg w-100 mx-auto" style="max-width: 1200px;">
                <div class="card-header">
                    <h3 class="mb-0">Sales Detail Report</h3>
                </div>
                <div class="card-body">
                    <p class="text-muted">View sales data filtered by month or date.</p>

                    <!-- Filter Section -->
                    <div class="row my-4">
                        <!-- <div class="col-md-6 mb-3">
                            <label for="monthFilter" class="form-label font-weight-bold">Filter by Month</label>
                            <input type="month" class="form-control" id="monthFilter">
                        </div> -->
                        <div class="col-md-2 mb-3">
                            <label for="dateFilter" class="form-label font-weight-bold">Filter by Date</label>
                            <input type="date" class="form-control" id="dateFilter">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="TotalSaleAmount" class="form-label font-weight-bold">Total Sale Amount</label>
                            <p id="totalSaleAmmunt"></p>
                        </div>
                    </div>

                    <!-- Sales Table -->
                    <div class="table-responsive rounded-lg shadow-sm border">
                        <table class="table table-striped table-hover mb-0" id="salesTable">
                            <thead class="thead-light">
                                <tr>
                                    <th scope="col">Date</th>
                                    <th scope="col">Product Name</th>
                                    <th scope="col">Quantity</th>
                                    <th scope="col">Price/Unit</th>
                                    <th scope="col">Total Unit Price</th>
                                </tr>
                            </thead>
                            <tbody id="salesTableBody">
                                <!-- Data will be populated here by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Loading Indicator -->
                    <div id="loadingIndicator" class="text-center py-5 text-muted d-none">
                        <p>Loading sales data...</p>
                    </div>
                </div>
            </div>
        </div>

    </section>


    <script>
        document.addEventListener('DOMContentLoaded', function () {
            //const monthFilter = document.getElementById('monthFilter');
            const dateFilter = document.getElementById('dateFilter');
            const salesTableBody = document.getElementById('salesTableBody');
            const loadingIndicator = document.getElementById('loadingIndicator');
            let totalSaleAmount = document.getElementById('totalSaleAmmunt');


            // This function simulates fetching data from a backend API
            async function fetchSalesData(month, date) {
                // In a real application, you would make a fetch call here:
                // const response = await fetch(`/api/sales?month=${month}&date=${date}`);
                // const data = await response.json();
                if (date) {
                    let dateParts = date.split('-');

                    let monthNumber = parseInt(dateParts[1]); // 8
                    let dayNumber = parseInt(dateParts[2]);
                    const filterDate = dateParts[0] + "-" + monthNumber + "-" + dayNumber;

                    const response = await fetch(`/sale/details/date?date=${filterDate}`)
                    const data_x = await response.json();
                    for (const sl of data_x) {
                        console.log('dass ' + JSON.stringify(sl))
                    }
                    renderSalesData(data_x);
                    //console.log('data_xdata_xdata_x'+ JSON.stringify(data_x))
                }

            }

            function renderSalesData(data) {
                salesTableBody.innerHTML = '';
                if (data.length === 0) {
                    const noDataRow = document.createElement('tr');
                    noDataRow.innerHTML = `<td colspan="4" class="text-center text-muted">No sales data available.</td>`;
                    salesTableBody.appendChild(noDataRow);
                    return;
                }
                console.log('DADADADADA ' + JSON.stringify(data))
                // Iterate through each 'Sale' object and then through its 'saleItems'
                let totalSale = 0;
                data.forEach(sale => {
                    const formattedDate = new Date(sale.saleDate).toLocaleDateString();
                    sale.items.forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${formattedDate}</td>
                            <td>${item.productInfo}</td>
                            <td>${item.quantitySold}</td>
                            <td>${item.unitPriceAtSale}</td>
                             <td>${item.unitPriceAtSale * item.quantitySold}</td>
                        `;
                        totalSale += item.unitPriceAtSale * item.quantitySold;
                        
                        salesTableBody.appendChild(row);
                    });
                });
                totalSaleAmount.textContent = totalSale;
                console.log('totalSaletotalSale ' + totalSale)



            }

            async function filterSalesData() {
                loadingIndicator.classList.remove('d-none');

                //const monthValue = monthFilter.value;
                const dateValue = dateFilter.value;

                try {
                    fetchSalesData(null, dateValue);
                    //renderSalesData(filteredSales);
                } catch (error) {
                    console.error("Error fetching sales data:", error);
                    salesTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Failed to load sales data.</td></tr>';
                } finally {
                    loadingIndicator.classList.add('d-none');
                }
            }

            // monthFilter.addEventListener('change', () => {
            //     dateFilter.value = ''; // Clear date filter when month changes
            //     filterSalesData();
            // });

            dateFilter.addEventListener('change', () => {
                // monthFilter.value = ''; // Clear month filter when date changes
                filterSalesData();
            });

            // Initial render
            filterSalesData();
        });
    </script>
</body>