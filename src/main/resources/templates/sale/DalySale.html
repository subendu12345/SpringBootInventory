<!DOCTYPE html>
<html lang="en" xmlns="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
    th:replace="base::layout(~{::section})">

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Sale Detail</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>

</head>

<section>
    <div class="container-fluid mt-5">
         <p id="resultMessage" class="mt-4 font-medium text-center"></p>
        <div class="card shadow rounded-lg w-100 mx-auto">
            <div class="card-header">
                <h3 class="mb-0">Sales Detail Report</h3>
            </div>
            <div class="card-body">
                <p class="text-muted">View sales data filtered by month or date.</p>

                <!-- Filter Section -->
                <div class="row my-4">
                    <!-- <div class="col-md-6 mb-3">
                            <label for="monthFilter" class="form-label font-weight-bold">Filter by Month</label>
                            <input type="month" class="form-control" id="monthFilter">
                        </div> -->
                    <div class="col-md-2 mb-3">
                        <label for="dateFilter" class="form-label font-weight-bold">Filter by Date</label>
                        <input type="date" class="form-control" id="dateFilter">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="TotalSaleAmount" class="form-label font-weight-bold">Total Sale Amount</label>
                        <p id="totalSaleAmmunt"></p>
                    </div>
                </div>

                <!-- Sales Table -->
                <div class="table-responsive rounded-lg shadow-sm border">
                    <table class="table table-striped table-hover mb-0" id="salesTable">
                        <thead class="thead-light">
                            <tr>
                                <th scope="col">Date</th>
                                <th scope="col">Product Name</th>
                                <th scope="col">Quantity</th>
                                <th scope="col">Price/Unit</th>
                                <th scope="col">Total Unit Price</th>
                                <!-- Add the "Action" column only if the user has the 'ADMIN' role -->
                                <th th:if="${session.sessionObj.role == 'ADMIN'}" scope="col">Action</th>
                            </tr>
                        </thead>
                        <tbody id="salesTableBody">
                            <!-- Data will be populated here by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- Confirmation Modal -->
                <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title font-bold" id="confirmModalLabel">Confirmation Required</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p id="confirmMessage">Are you sure you want to perform this action?</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary rounded-lg"
                                    data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-danger rounded-lg"
                                    id="confirmActionBtn">Confirm</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading Indicator -->
                <div id="loadingIndicator" class="text-center py-5 text-muted d-none">
                    <p>Loading sales data...</p>
                </div>
            </div>
        </div>
    </div>
    <script>


        document.addEventListener('DOMContentLoaded', () => {
            //const monthFilter = document.getElementById('monthFilter');
            const dateFilter = document.getElementById('dateFilter');
            const salesTableBody = document.getElementById('salesTableBody');
            const loadingIndicator = document.getElementById('loadingIndicator');
            let totalSaleAmount = document.getElementById('totalSaleAmmunt');
            const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
            const confirmMessageEl = document.getElementById('confirmMessage');
            const confirmActionBtn = document.getElementById('confirmActionBtn');
            const showModalBtn = document.getElementById('showModalBtn');
            const resultMessageEl = document.getElementById('resultMessage');
            dateFilter.value = new Date();
            let saleId;
            let saleItemId;

            const hasActionColumn = document.querySelector('th[scope="col"]:last-child') &&
                document.querySelector('th[scope="col"]:last-child').textContent.trim() === 'Action';


            // This function simulates fetching data from a backend API
            async function fetchSalesData(month, date) {
                // In a real application, you would make a fetch call here:
                // const response = await fetch(`/api/sales?month=${month}&date=${date}`);
                // const data = await response.json();
                if (date) {
                    let dateParts = date.split('-');
                    let monthNumber = parseInt(dateParts[1]); // 8
                    let dayNumber = parseInt(dateParts[2]);
                    const filterDate = dateParts[0] + "-" + monthNumber + "-" + dayNumber;

                    const response = await fetch(`/sale/details/date?date=${date}`)
                    const data_x = await response.json();
                    renderSalesData(data_x);
                    //console.log('data_xdata_xdata_x'+ JSON.stringify(data_x))
                }

            }

            function renderSalesData(data) {
                salesTableBody.innerHTML = '';
                if (data.length === 0) {
                    const noDataRow = document.createElement('tr');
                    noDataRow.innerHTML = `<td colspan="4" class="text-center text-muted">No sales data available.</td>`;
                    salesTableBody.appendChild(noDataRow);
                    return;
                }
                let totalSale = 0;
                data.forEach(sale => {
                    const formattedDate = new Date(sale.saleDate).toLocaleDateString();
                    sale.items.forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${formattedDate}</td>
                            <td>${item.productInfo}</td>
                            <td>${item.quantitySold}</td>
                            <td>${item.unitPriceAtSale}</td>
                             <td>${item.unitPriceAtSale * item.quantitySold}</td>                           
                        `;
                        if (hasActionColumn) {
                            row.innerHTML += `<td>
                                <!-- The delete button will be populated if the user has 'ROLE_ADMIN' -->
                                <button class="btn btn-danger btn-sm delete-btn" onclick="deleteSaleItem('${sale.saleId}', '${item.saleItemId}')"> Delete</button>
                            </td>`
                        }

                        totalSale += item.unitPriceAtSale * item.quantitySold;

                        salesTableBody.appendChild(row);
                    });
                });
                totalSaleAmount.textContent = totalSale;
            }

            async function filterSalesData() {
                loadingIndicator.classList.remove('d-none');

                //const monthValue = monthFilter.value;
                const dateValue = dateFilter.value;

                try {
                    fetchSalesData(null, dateValue);
                    //renderSalesData(filteredSales);
                } catch (error) {
                    console.error("Error fetching sales data:", error);
                    salesTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Failed to load sales data.</td></tr>';
                } finally {
                    loadingIndicator.classList.add('d-none');
                }
            }


            window.deleteSaleItem = function (id, itemId) {
                saleId = id;
                saleItemId = itemId;
                console.log('deleteSaleItem  ' + id + " itemId " + itemId)
                showDeleteModal(id, itemId)
            }

            // Show and handle the custom confirmation modal
            function showDeleteModal(saleId, saleItemId) {
                showConfirmModal(
                    "Are you sure you want to delete this Sale-Item? This action cannot be undone.",
                    () => {
                        // This is the function that runs on confirmation.
                        console.log("User deletion confirmed!");
                    }
                );
            }

            function showConfirmModal(message, callback) {
                confirmMessageEl.textContent = message;
                confirmationCallback = callback;
                confirmModal.show();
            }

            // Event listener for the "Confirm" button inside the modal
            confirmActionBtn.addEventListener('click', () => {
                if (confirmationCallback) {
                    handleDeleteSale();
                }
                confirmModal.hide();
            });



            async function handleDeleteSale() {
                console.log('---SaleId--> ' + saleId + ' ----itemId ' + saleItemId);
                if (saleId == null || saleItemId == null) return;

                try {
                    const response = await fetch(`/sale/delete/${parseInt(saleId)}/items/${parseInt(saleItemId)}`, {
                        method: 'DELETE',
                    });

                    if (response.ok) {
                        // alert("Sale deleted successfully!");
                        // Re-fetch data to update the table
                        resultMessageEl.textContent = "Action Confirmed: Sale-Item has been deleted.";
                        resultMessageEl.className = "mt-4 font-semibold text-green-600";
                        const dateFilter = document.getElementById('dateFilter');
                        fetchSalesData(null, dateFilter.value);
                    } else {
                        // alert("Failed to delete the sale. You may not have the necessary permissions.");
                        console.error("Delete failed with status:", response.status);
                    }
                } catch (error) {
                    console.error("Error during delete operation:", error);
                    // alert("An error occurred. Please try again.");
                }

            }

            // monthFilter.addEventListener('change', () => {
            //     dateFilter.value = ''; // Clear date filter when month changes
            //     filterSalesData();
            // });

            dateFilter.addEventListener('change', () => {
                console.log("---------------------------------")
                // monthFilter.value = ''; // Clear month filter when date changes
                filterSalesData();
            });
            // Initial render
            // filterSalesData();
        });
    </script>
</section>